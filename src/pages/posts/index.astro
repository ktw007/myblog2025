---
import { getCollection } from 'astro:content';
import { siteConfig } from '@/config';
import { generatePageSEO } from '@/utils/seo';
import { shouldShowPost, sortPostsByDate, extractTags } from '@/utils/markdown';
import { optimizePostImagePath } from '@/utils/images';
import BaseLayout from '@/layouts/BaseLayout.astro';
import PostCard from '@/components/PostCard.astro';
import Tags from '@/components/Tags.astro';
import Pagination from '@/components/Pagination.astro';
import Icon from '@/components/Icon.astro';

// Get special content for posts page
let postsPageContent;
try {
  postsPageContent = await getCollection('special', ({ slug }) => slug === 'posts');
} catch (error) {
  // Fallback if special collection doesn't exist or posts.md doesn't exist
  postsPageContent = [];
}

const postsPageData = postsPageContent.length > 0 ? postsPageContent[0] : null;

// Get query parameters
const url = new URL(Astro.request.url);
const selectedTag = url.searchParams.get('tag');

// Get all posts
const allPosts = await getCollection('posts');

// Filter posts based on environment
const isDev = import.meta.env.DEV;
const visiblePosts = allPosts.filter(post => shouldShowPost(post, isDev));

// Sort posts by date (newest first)
const sortedPosts = sortPostsByDate(visiblePosts);

// Filter by tag if specified
const filteredPosts = selectedTag
  ? sortedPosts.filter(post => post.data.tags?.includes(selectedTag))
  : sortedPosts;

// Pagination
const postsPerPage = siteConfig.postOptions.postsPerPage;
const totalPosts = filteredPosts.length;
const totalPages = Math.ceil(totalPosts / postsPerPage);
const currentPage = 1; // This is the first page
const startIndex = 0;
const endIndex = Math.min(postsPerPage, totalPosts);
const paginatedPosts = filteredPosts.slice(startIndex, endIndex);

// Extract all unique tags
const allTags = extractTags(sortedPosts);

// Generate SEO data
const pageTitle = selectedTag
  ? `Posts tagged "${selectedTag}"`
  : (postsPageData?.data.title || 'All Posts');
const pageDescription = selectedTag
  ? `All posts tagged with "${selectedTag}"`
  : (postsPageData?.data.description || `Browse all ${totalPosts} posts on ${siteConfig.title}`);

const seoData = {
  title: `${pageTitle} | ${siteConfig.title}`,
  description: pageDescription,
  canonical: Astro.url.href,
  ogType: 'website' as const
};

// Pagination info
const baseUrl = selectedTag ? `/posts?tag=${encodeURIComponent(selectedTag)}` : '/posts';
const pagination = {
  currentPage,
  totalPages,
  hasNext: currentPage < totalPages,
  hasPrev: false,
  nextUrl: totalPages > 1 ? '/posts/2' : undefined,
  prevUrl: undefined
};
---

<BaseLayout seoData={seoData}>
  <Fragment slot="head">
    <!-- Preload only the first post's image to avoid unused preload warnings -->
    {paginatedPosts.length > 0 && (() => {
      const firstPost = paginatedPosts[0];
      if (!firstPost.data.image || typeof firstPost.data.image === 'string' && firstPost.data.image.startsWith('http')) return null;

      const showCoverImages = siteConfig.postOptions.showPostCardCoverImages;
      const shouldShowCoverImage = ['all', 'posts', 'featured-and-posts'].includes(showCoverImages);

      return shouldShowCoverImage ? (
        <link
          rel="preload"
          as="image"
          href={optimizePostImagePath(firstPost.data.image, undefined, firstPost.id)}
          fetchpriority="high"
        />
      ) : null;
    })()}
  </Fragment>

  <div class="py-8 relative">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 mb-12" style={`max-width: ${siteConfig.layout.contentWidth}`}>
      <!-- Header -->
      <header class="mb-8">
        <div class="flex items-start justify-between mb-3">
          <h1 class="text-lg font-bold text-primary-900 dark:text-primary-50">
            {pageTitle}
          </h1>
          <div class="flex items-center space-x-2">
            <a
              href="https://xhslink.com/m/6Geph6VJ5Ix"
              target="_blank"
              rel="noopener noreferrer"
              class="inline-flex items-center px-3 py-2 text-sm font-medium text-highlight-600 dark:text-highlight-400 bg-highlight-50 dark:bg-highlight-900/20 rounded-lg border border-highlight-200 dark:border-highlight-700 hover:bg-highlight-100 dark:hover:bg-highlight-900/40 hover:text-highlight-700 dark:hover:text-highlight-300 transition-all duration-200"
              title="关注我的小红书"
              data-no-swup
            >
              <svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
              </svg>
              小红书
            </a>
            <div class="relative wechat-wrapper">
              <button
                id="wechat-button"
                class="inline-flex items-center px-3 py-2 text-sm font-medium text-highlight-600 dark:text-highlight-400 bg-highlight-50 dark:bg-highlight-900/20 rounded-lg border border-highlight-200 dark:border-highlight-700 hover:bg-highlight-100 dark:hover:bg-highlight-900/40 hover:text-highlight-700 dark:hover:text-highlight-300 transition-all duration-200"
                title="微信: ktws007"
              >
                <svg class="w-4 h-4 mr-1.5" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M8.5 8.5C9.33 8.5 10 7.83 10 7s-.67-1.5-1.5-1.5S7 6.17 7 7s.67 1.5 1.5 1.5zm7 0c.83 0 1.5-.67 1.5-1.5S16.33 5.5 15.5 5.5 14 6.17 14 7s.67 1.5 1.5 1.5zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8 0-1.85.63-3.55 1.69-4.9L4.3 5.71A9.9 9.9 0 0 0 2.05 12c0 5.52 4.48 10 10 10s10-4.48 10-10-4.48-10-10-10c-2.43 0-4.66.87-6.4 2.3L7 5.7C8.45 4.63 10.15 4 12 4c4.41 0 8 3.59 8 8s-3.59 8-8 8z"/>
                </svg>
                微信
              </button>
              <div id="wechat-popup" class="wechat-popup" style="display: none;">
                <div class="wechat-popup-content">
                  <button class="wechat-close" aria-label="关闭">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                  </button>
                  <img src="/assets/77E46EF62D3F77DB2AA13A0BEC1CAAE0.jpg" alt="微信二维码" class="wechat-qr" />
                  <p class="wechat-text">扫码添加我的微信</p>
                  <p class="wechat-id">微信号: <span>ktws007</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <p class="text-base text-primary-600 dark:text-primary-300">
          {selectedTag ? (
            <>
              Showing <strong>{filteredPosts.length}</strong> posts tagged with
              <span class="inline-flex items-center px-2 py-1 bg-highlight-100 dark:bg-highlight-900/30 text-highlight-800 dark:text-highlight-200 rounded text-sm font-medium ml-1">
                #{selectedTag}
              </span>
            </>
          ) : (
            <>Explore all <strong>{totalPosts}</strong> posts</>
          )}
        </p>

        {selectedTag && (
          <div class="mt-4">
            <a
              href="/posts"
              class="inline-flex items-center text-sm text-primary-600 dark:text-primary-300 hover:text-primary-800 dark:hover:text-primary-200 transition-colors"
            >
              <Icon name="arrow-left" class="w-4 h-4 mr-1" />
              Show all posts
            </a>
          </div>
        )}
      </header>

      <div class="relative">
        <!-- Main content -->
        <div class="max-w-none">
          {paginatedPosts.length > 0 ? (
            <>
              <!-- Posts list -->
              <div class="space-y-4 mb-12">
                {paginatedPosts.map((post, index) => (
                  <PostCard post={post} eager={index < 2} context="posts" />
                ))}
              </div>

              <!-- Pagination -->
              <Pagination pagination={pagination} baseUrl={baseUrl} />
            </>
          ) : selectedTag ? (
            <!-- No posts for selected tag -->
            <div class="text-center py-16">
              <Icon name="tag" class="w-16 h-16 text-primary-400 dark:text-primary-500 mx-auto mb-6" />
              <h2 class="font-semibold text-primary-900 dark:text-primary-50 mb-4">
                No posts found
              </h2>
              <p class="text-primary-600 dark:text-primary-300 mb-8 max-w-md mx-auto">
                There are no posts tagged with "{selectedTag}". Try browsing other tags or
                <a href="/posts" class="text-primary-600 dark:text-primary-300 hover:underline">view all posts</a>.
              </p>
            </div>
          ) : (
            <!-- No posts at all -->
            <div class="text-center py-16">
              <Icon name="file-text" class="w-16 h-16 text-primary-400 dark:text-primary-500 mx-auto mb-6" />
              <h2 class="text-2xl font-semibold text-primary-900 dark:text-primary-50 mb-4">
                No posts yet
              </h2>
              <p class="text-primary-600 dark:text-primary-300 mb-8">
                This blog is just getting started. Check back soon for new content!
              </p>
              {isDev && (
                <div class="max-w-md mx-auto p-4 bg-blue-50 dark:bg-blue-950 rounded-lg border border-blue-200 dark:border-blue-800">
                  <p class="text-sm text-blue-800 dark:text-blue-200">
                    <strong>Dev Mode:</strong> Add some posts to the <code>content/posts/</code> directory to see them here.
                  </p>
                </div>
              )}
            </div>
          )}
        </div>

        <!-- Mobile sidebar - appears below content on mobile/tablet -->
        <div class="xl:hidden mt-12 space-y-6">
          <!-- Tags -->
          {siteConfig.postOptions.tags && allTags.length > 0 && (
            <Tags tags={allTags} />
          )}
        </div>

        <!-- Desktop sidebar - floats to the right of the content container -->
        <div class="hidden xl:block absolute top-0 left-full ml-8 w-64">
          <div class="sticky top-24 space-y-3 max-h-[calc(100vh-12rem)] overflow-y-auto pb-6">
            <!-- Tags -->
            {siteConfig.postOptions.tags && allTags.length > 0 && (
              <Tags tags={allTags} />
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  // WeChat popup handler
  document.addEventListener('DOMContentLoaded', () => {
    const wechatButton = document.getElementById('wechat-button');
    const wechatPopup = document.getElementById('wechat-popup');
    const closeButton = wechatPopup?.querySelector('.wechat-close');

    if (wechatButton && wechatPopup) {
      // Toggle popup
      wechatButton.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = wechatPopup.style.display === 'block';
        wechatPopup.style.display = isVisible ? 'none' : 'block';
      });

      // Close button
      if (closeButton) {
        closeButton.addEventListener('click', (e) => {
          e.stopPropagation();
          wechatPopup.style.display = 'none';
        });
      }

      // Close when clicking outside
      document.addEventListener('click', (e) => {
        if (!wechatButton.contains(e.target) && !wechatPopup.contains(e.target)) {
          wechatPopup.style.display = 'none';
        }
      });

      // Close on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && wechatPopup.style.display === 'block') {
          wechatPopup.style.display = 'none';
        }
      });
    }
  });
</script>

<style>
  /* Enhanced posts page styles */
  .posts-grid {
    display: grid;
    gap: 2rem;
  }

  @media (min-width: 768px) {
    .posts-grid {
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    }
  }

  /* Tag highlight in header */
  .tag-highlight {
    @apply bg-gradient-to-r from-highlight-500 to-highlight-600 text-white;
  }

  /* WeChat Popup Styles */
  .wechat-wrapper {
    position: relative;
    display: inline-block;
  }

  .wechat-popup {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    z-index: 9999;
    animation: popupFadeIn 0.2s ease-out;
  }

  /* Adjust position on small screens */
  @media (max-width: 640px) {
    .wechat-popup {
      right: auto;
      left: 50%;
      transform: translateX(-50%);
    }
  }

  .wechat-popup-content {
    background: white;
    border-radius: 1rem;
    padding: 1.5rem;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    border: 1px solid rgba(0, 0, 0, 0.1);
    min-width: 280px;
    max-width: 320px;
    position: relative;
  }

  @media (prefers-color-scheme: dark) {
    .wechat-popup-content {
      background: rgb(31, 41, 55);
      border-color: rgb(55, 65, 81);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
    }
  }

  .wechat-close {
    position: absolute;
    top: 0.75rem;
    right: 0.75rem;
    color: #6b7280;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 0.375rem;
    transition: all 0.2s;
    z-index: 10;
  }

  .wechat-close:hover {
    color: #374151;
    background: rgba(0, 0, 0, 0.05);
  }

  @media (prefers-color-scheme: dark) {
    .wechat-close {
      color: #9ca3af;
    }
    .wechat-close:hover {
      color: #d1d5db;
      background: rgba(255, 255, 255, 0.1);
    }
  }

  .wechat-qr {
    width: 100%;
    height: auto;
    max-width: 250px;
    margin: 0 auto;
    display: block;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
  }

  .wechat-text {
    text-align: center;
    color: #4b5563;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  @media (prefers-color-scheme: dark) {
    .wechat-text {
      color: #d1d5db;
    }
  }

  .wechat-id {
    text-align: center;
    color: #6b7280;
    font-size: 0.75rem;
  }

  .wechat-id span {
    font-family: monospace;
    font-weight: 600;
    color: #374151;
  }

  @media (prefers-color-scheme: dark) {
    .wechat-id {
      color: #9ca3af;
    }
    .wechat-id span {
      color: #e5e7eb;
    }
  }

  @keyframes popupFadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Fix transform on mobile */
  @media (max-width: 640px) {
    @keyframes popupFadeIn {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }
  }

  /* Arrow pointer */
  .wechat-popup::before {
    content: '';
    position: absolute;
    top: -6px;
    right: 1rem;
    width: 12px;
    height: 12px;
    background: white;
    border-left: 1px solid rgba(0, 0, 0, 0.1);
    border-top: 1px solid rgba(0, 0, 0, 0.1);
    transform: rotate(45deg);
  }

  @media (max-width: 640px) {
    .wechat-popup::before {
      right: auto;
      left: 50%;
      margin-left: -6px;
    }
  }

  @media (prefers-color-scheme: dark) {
    .wechat-popup::before {
      background: rgb(31, 41, 55);
      border-color: rgb(55, 65, 81);
    }
  }
</style>
